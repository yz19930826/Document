# PE服务端修改说明文档

## 网银客户端登录介绍
当前网银客户端采用的表现和逻辑相分离的技术。


展示采用的是本地HTML静态页面，可以极大的提高软件打开的效率，提升用户体验。

逻辑采用的是C++;

如下图：
![](http://p1hy9syru.bkt.clouddn.com/18-2-8/33718736.jpg)

### ajax登录

因表现采用的是本地HTML页面的方式，所以客户端登录到网银系统采用的也就是Form表单或者ajax登录。

From表单登录后会自动跳转，若是本地页面登录会导致JS、CSS等资源寻找不到，所以这种方式不采用。

利用Ajax技术登录是个很好的解决方案，但是Ajax是局部刷新技术，登录成功，虽然我们可以获取到页面的数据，但是没办法实现自动的跳转，只能手动指定url路径，利用```window.location.href="" ```来进行跳转。这样一来我们就需要一个可以囊括登录成功之后所有交易的地址。如```main.jsp```。


### 实现登录流程如下

1. Ajax将所需要到数据发给接口，如:```login.do ```
2. 服务端会返回登录是否成功或者失败的信息
3. Ajax拿到这些信息，进行判断逻辑，是执行跳转或者将登录失败的信息显示出来。

如图所示：
![](http://p1hy9syru.bkt.clouddn.com/18-2-8/69075386.jpg)

## PE服务端修改

### 登录跳转的修改
因Ajax需要手动指定跳转的地址，该地址也就是PE系统用户登录成功之后的页面地址。

PE系统内部采用的应该是请求转发的方式进行的跳转，因此url的路径不会发生任何变化，我们也就无法捕捉到这个url地址。

所以PE系统需要额外提供一个接口，供网银客户端登录成功之后让其指定该接口进行跳转。

如下，这里的main.do可以跳转到登录成功之后的信息页，当然这个接口需要对用户的Session进行判断，以防止不合法用户的登入：
```
if(login == success){
    window.location.href="main.do";
}

```

### 返回到登录页的修改
网银上会有一些**返回上一步**，或者是**返回登录**的按钮，点击就会返回到登录页。如天津银行
![](http://p1hy9syru.bkt.clouddn.com/18-2-8/60193196.jpg)

点击注册后
![](http://p1hy9syru.bkt.clouddn.com/18-2-8/86549512.jpg)

如果返回到上一步，就会回到网银的登录页面。上面说过，客户端采用的是本地静态页面的方式表现，当客户端和网银已经整合，用户点击返回上一步就会跳到网银的登录页面而不是客户端的登录页面，这样体验就会很差。所以网银系统前端需要更新一个逻辑（不影响以前的逻辑），我们会提供接口用于判断用户打开网银是否在客户端中，若是在客户端中，则跳转到客户端的登录页。

简单的逻辑如下：
```
  //判断网银是否在客户端中打开
  function GetCoreBrowser() {
    var u;
    try {
      //csii_get_corebrowser()由客户端提供，只需调用即可
      u = csii_get_corebrowser(); //返回客户端核心标识："CSII-ClientEBank"
      return u;
    } catch (e) {
      u = navigator.userAgent;
      return u;
    }
  }

  //返回上一步逻辑，若判断是在客户端中，则调用客户端提供的返回登录页代码
  function ReLogin() //返回登录页面
  {
    if (GetCoreBrowser() == "CSII-ClientEBank") {
      csii_cef_gologin(); //返回客户端登录界面csii_cef_relogin重新启动程序
    } else {
      // 原有返回到登录页逻辑
    }

  }

```
